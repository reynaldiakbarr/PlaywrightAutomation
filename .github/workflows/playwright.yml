name: Playwright Tests
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

# PENTING: Menambahkan izin untuk menulis ke branch gh-pages
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-node@v4
      with:
        node-version: lts/*

    - name: Install dependencies
      run: npm install

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps

    - name: Run Playwright tests
      run: npx playwright test
      continue-on-error: true # Agar Allure tetap dibuat meski ada test yang gagal

    # --- BAGIAN ALLURE REPORT DIMULAI DI SINI ---
    
    - name: Load Allure history
      uses: actions/checkout@v4
      if: always()
      continue-on-error: true
      with:
        ref: gh-pages
        path: gh-pages-dir

    - name: Generate Allure Report
      uses: simple-elf/allure-report-action@master
      if: always()
      with:
        allure_results: allure-results
        allure_history: allure-history-dir
        keep_reports: 20

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      if: always()
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: allure-history-dir
        publish_branch: gh-pages

    # --- BAGIAN NOTIFIKASI TELEGRAM ---

    - name: Send Telegram Notification
      if: always()
      env:
        BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        REPORT_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        MESSAGE="üé≠ *Allure Report Ready!* üé≠%0A%0Aüìä Status: ${{ job.status }}%0Aüåê Link: $REPORT_URL"
        
        curl -s -X POST https://api.telegram.org/bot$BOT_TOKEN/sendMessage \
          -d chat_id=$CHAT_ID \
          -d text="$MESSAGE" \
          -d parse_mode="Markdown"

    # Tetap simpan artifact standar sebagai backup
    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30