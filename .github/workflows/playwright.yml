name: Playwright Tests
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

# PENTING: Menambahkan izin untuk menulis ke branch gh-pages
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-node@v4
      with:
        node-version: lts/*

    - name: Install dependencies
      run: npm install

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps

    - name: Run Playwright tests
      run: npx playwright test
      continue-on-error: true # Agar Allure tetap dibuat meski ada test yang gagal

    - name: "Debug: List Allure Results"
      run: ls -R allure-results # Perintah ini untuk melihat apakah ada file .json di sana

    # --- BAGIAN ALLURE REPORT DIMULAI DI SINI ---
    
    - name: Load Allure history
      uses: actions/checkout@v4
      if: always()
      continue-on-error: true
      with:
        ref: gh-pages
        path: gh-pages-dir

    - name: Generate Allure Report
      uses: simple-elf/allure-report-action@master
      if: always()
      with:
        allure_results: allure-results
        allure_history: allure-history-dir
        keep_reports: 20

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      if: always()
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: allure-history-dir
        publish_branch: gh-pages

    # --- BAGIAN NOTIFIKASI TELEGRAM ---

    - name: Send Telegram Notification
      if: always()
      env:
        BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        # Mengambil data dari Allure summary
        PASSED=$(jq '.statistic.passed' allure-history-dir/widgets/summary.json)
        FAILED=$(jq '.statistic.failed' allure-history-dir/widgets/summary.json)
        SKIPPED=$(jq '.statistic.skipped' allure-history-dir/widgets/summary.json)
        TOTAL=$(jq '.statistic.total' allure-history-dir/widgets/summary.json)
        
        # Menghitung persentase
        if [ "$TOTAL" -gt 0 ]; then
          PASSED_PERCENT=$(( PASSED * 100 / TOTAL ))
          FAILED_PERCENT=$(( FAILED * 100 / TOTAL ))
        else
          PASSED_PERCENT=0
          FAILED_PERCENT=0
        fi

        # Menentukan Emoji Status
        if [ "$FAILED" -eq 0 ]; then STATUS_EMOJI="‚úÖ"; else STATUS_EMOJI="‚ùå"; fi

        REPORT_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        
        MESSAGE="$STATUS_EMOJI *Allure Test Report* $STATUS_EMOJI%0A%0A"
        MESSAGE+="üìä *Summary:*%0A"
        MESSAGE+="‚Ä¢ Total Tests: $TOTAL%0A"
        MESSAGE+="‚Ä¢ Passed: $PASSED ($PASSED_PERCENT%)%0A"
        MESSAGE+="‚Ä¢ Failed: $FAILED ($FAILED_PERCENT%)%0A"
        MESSAGE+="‚Ä¢ Skipped: $SKIPPED%0A%0A"
        MESSAGE+="üåê *Full Report:* [Click Here]($REPORT_URL)"
        
        curl -s -X POST https://api.telegram.org/bot$BOT_TOKEN/sendMessage \
          -d chat_id=$CHAT_ID \
          -d text="$MESSAGE" \
          -d parse_mode="Markdown"

    # Tetap simpan artifact standar sebagai backup
    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30